Option Explicit


Sub Create_ETC_tab()

Application.ScreenUpdating = False
Application.DisplayAlerts = False
Application.SheetsInNewWorkbook = 3

''IncrementalProgress.Show
''IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Starting execution"

Dim Designations(30) As String
Dim Service_line(30) As String
Dim Emp_name(100) As String
Dim Desig_number(100) As Integer
Dim subtotal_column(10) As Integer
Dim path, Filename As String
Dim a, i, j, k, x As Integer
Dim last_row, last_row1, last_row_desg As Integer
Dim Column_to_begin_old As Integer

Dim Wk As Workbook
path = Application.ActiveWorkbook.path
Set Wk = ActiveWorkbook

''''changes uncomment the service lines

Service_line(1) = "AUDIT"
Service_line(2) = "ERS"
Service_line(3) = "TAX"
Service_line(4) = "LIFE ACTUARIAL"
Service_line(5) = "P&C ACTUARIAL"
Service_line(6) = "USI"

Sheets("Lists").Select
If ActiveSheet.AutoFilterMode = True Then ActiveSheet.AutoFilterMode = False
Range("K4:K1048").Select
Selection.ClearContents

last_row_desg = Range("J4").End(xlDown).Row
For k = 1 To last_row_desg - 3
Cells(k + 3, 11).Value = k
Next k

'Sheets("Budget by Week").Select
'
'If SheetExists("ETC") = "True" Then
'Sheets("ETC").Select
'ActiveWindow.SelectedSheets.Delete
'End IfSheetExists("ETC") = "True" Then
'
'Sheets.Add
'ActiveSheet.Name = "ETC"

Sheets("ETC").Select
Cells.Clear

Cells(5, 1).Value = "ALLCORP"
Cells(5, 2).Value = "Lvl2 WBS Name"
Cells(5, 3).Value = "Area"

Range(Cells(5, 1), Cells(5, 3)).Select
Selection.Font.Bold = True
Call paint_it_purple

For i = 1 To 3
Cells(5, i).Select
Call create_borders
Next i

Sheets("WBS").Select
Range(Cells(3, 3), Cells(3, 4)).Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

Sheets("ETC").Select
Range("B6").Select
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False

last_row = Range("B6").End(xlDown).Row

For i = 1 To 3
Range(Cells(5, i), Cells(last_row, i)).Select
Call create_borders
Next i

Dim column_to_begin, number_of_desig, l As Integer
Dim Designation As String
column_to_begin = 5

''''''''''''''''''looping begin

''''changes from 1 to 6

For a = 1 To 6

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed:" & Service_line(a)

Filename = Service_line(a) & ".xlsx"
Sheets("Lists").Select
Range("A2:D2").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=1, Criteria1:=(Service_line(a)), Operator:=xlFilterValues

If Range("A1000000").End(xlUp).Row = 2 Then GoTo NoServiceLine

Range(Cells(2, "A"), Cells(2, "C").End(xlDown)).Select
Selection.Copy

Workbooks.Add
ActiveSheet.Paste

ActiveWorkbook.SaveAs path & "\" & Filename
last_row1 = Range("A1").End(xlDown).Row

Range(Cells(1, 3), Cells(last_row1, 3)).Select
Selection.Copy
Sheets("sheet2").Select
ActiveSheet.Paste
ActiveSheet.Range("$A$1:$A$" & last_row1).RemoveDuplicates Columns:=1, Header:=xlYes
number_of_desig = Range("A1").End(xlDown).Row - 1
Range("B1").Value = "order"

Wk.Activate
Sheets("Lists").Select
ActiveSheet.Range("C2").AutoFilter Field:=1
Range("J4:K4").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy
Workbooks(Filename).Activate
Sheets("sheet3").Select
Range("A1").Select
ActiveSheet.Paste

Sheets("Sheet2").Select
Range("b2").Select
ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-1],Sheet3!R1C1:R14C2,2,0)"
Selection.Copy
    Range("A1").End(xlDown).Offset(0, 1).Select
    Range(Selection, Selection.End(xlUp)).Select
    ActiveSheet.Paste
    
    Range("A1:B1").Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Add Key:=Range("B2:B" & number_of_desig + 1) _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet2").Sort
        .SetRange Range("A1:B" & number_of_desig + 1): .Header = xlYes: .MatchCase = False: .Orientation = xlTopToBottom: .SortMethod = xlPinYin: .Apply
    End With

For k = 1 To number_of_desig
Designations(k) = Cells(k + 1, 1).Value
Next k

Column_to_begin_old = column_to_begin

For i = 1 To number_of_desig

Workbooks(Filename).Activate
Sheets("sheet1").Select
Range("A1:C1").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=3
ActiveSheet.Range("C2").AutoFilter Field:=3, Criteria1:=(Designations(i)), Operator:=xlFilterValues

Designation = Designations(i)
Range(Cells(1, "B"), Cells(1, "B").End(xlDown)).Select
Selection.Copy
Workbooks.Add
ActiveSheet.Paste
Desig_number(i) = Range("A1").End(xlDown).Row - 1

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation being processed : " & Designation

For k = 1 To Desig_number(i)
Emp_name(k) = Cells(k + 1, 1).Value
Next k
ActiveWorkbook.Close SaveChanges:=False

Wk.Activate
Sheets("ETC").Select

For j = 1 To Desig_number(i)

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation : " & Designation & vbCrLf & "Employee : " & Emp_name(j)

Cells(3, column_to_begin + 4 * (j - 1) + 2).Value = Designation
Cells(5, column_to_begin + 4 * (j - 1)).Value = "Budget"
Cells(5, column_to_begin + 4 * (j - 1) + 1).Value = "Actual"
Cells(5, column_to_begin + 4 * (j - 1) + 2).Value = "ETC"
Cells(5, column_to_begin + 4 * (j - 1) + 3).Value = "Proj"

Cells(4, column_to_begin + 4 * (j - 1)).Value = Emp_name(j)

Range(Cells(4, column_to_begin + 4 * (j - 1)), Cells(4, column_to_begin + 4 * (j - 1) + 3)).Select
Call merge_and_center
Call paint_it_blue
Call create_borders

Range(Cells(5, column_to_begin + 4 * (j - 1)), Cells(5, column_to_begin + 4 * (j - 1) + 3)).Select
Selection.Font.Bold = True
Call paint_it_purple
Call create_borders

Range(Cells(5, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 3)).Select
Call create_borders

Cells(6, column_to_begin + 4 * (j - 1)).Select
ActiveCell.FormulaR1C1 = "=SUMIF(Budget_Range,'ETC'!RC3&""  ""&'ETC'!R4C,Budget_Hours)"
Cells(6, column_to_begin + 4 * (j - 1) + 1).Select
ActiveCell.FormulaR1C1 = "=SUMIF(DPS_Staff_Area,'ETC'!RC3&""  ""&'ETC'!R4C[-1],DPS_ActualHours)"
Cells(6, column_to_begin + 4 * (j - 1) + 2).Select
ActiveCell.FormulaR1C1 = "=IF(RC[-2]-RC[-1]<0,0,RC[-2]-RC[-1])"
Cells(6, column_to_begin + 4 * (j - 1) + 3).Select
ActiveCell.FormulaR1C1 = "=RC[-2]+RC[-1]"

Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(6, column_to_begin + 4 * (j - 1) + 3)).Select
Selection.Copy
Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 3)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False
Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 2)).Select
Selection.Copy
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False


Range(Cells(last_row + 1, column_to_begin + 4 * (j - 1)), Cells(last_row + 1, column_to_begin + 4 * (j - 1) + 3)).Select
Call create_borders

Range(Cells(last_row + 3, column_to_begin + 4 * (j - 1)), Cells(last_row + 3, column_to_begin + 4 * (j - 1) + 3)).Select
Call create_borders

Cells(last_row + 3, column_to_begin + 4 * (j - 1)).Select
ActiveCell.FormulaR1C1 = "=SUBTOTAL(9,R6C:R" & last_row & "C)"
Selection.Copy
Range(Cells(last_row + 3, column_to_begin + 4 * (j - 1)), Cells(last_row + 3, column_to_begin + 4 * (j - 1) + 3)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False
Selection.Font.Bold = True
Call create_borders

Range(Cells(6, column_to_begin + 4 * (j - 1) + 2), Cells(last_row + 1, column_to_begin + 4 * (j - 1) + 2)).Select
With Selection.Interior
        .Pattern = xlSolid:        .PatternColorIndex = xlAutomatic:        .ThemeColor = xlThemeColorDark1:        .TintAndShade = -0.149998474074526

End With

Next j

Range(Cells(2, column_to_begin), Cells(2, column_to_begin + 4 * (j - 1) - 1)).Select
Call merge_and_center
Selection.Font.Bold = True
Call paint_it_green
Call create_borders

ActiveCell.Value = Designation

column_to_begin = Cells(5, column_to_begin).End(xlToRight).Column + 2

Next i

column_to_begin = column_to_begin + 5

Dim service_line_length1, service_line_length As Integer

service_line_length = 0

For i = 1 To number_of_desig
service_line_length1 = service_line_length + (4 * Desig_number(i))
service_line_length = service_line_length1
Next i

Cells(4, Column_to_begin_old + service_line_length1 + number_of_desig).Value = "SUB TOTAL"
Range(Cells(4, Column_to_begin_old + service_line_length1 + number_of_desig), Cells(4, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Call merge_and_center
Call create_borders
Call paint_it_blue

Cells(5, Column_to_begin_old + service_line_length1 + number_of_desig).Value = "Budget"
Cells(5, Column_to_begin_old + service_line_length1 + number_of_desig + 1).Value = "Actual"
Cells(5, Column_to_begin_old + service_line_length1 + number_of_desig + 2).Value = "ETC"
Cells(5, Column_to_begin_old + service_line_length1 + number_of_desig + 3).Value = "Proj"

Cells(6, Column_to_begin_old + service_line_length1 + number_of_desig).Select
ActiveCell.FormulaR1C1 = "=SUMIF(R5C" & Column_to_begin_old & ":R5C" & column_to_begin - 7 & ",R5C,RC" & Column_to_begin_old & ":RC" & column_to_begin - 7 & ")"
Selection.Copy
Range(Cells(6, Column_to_begin_old + service_line_length1 + number_of_desig), Cells(last_row, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Call create_borders

Range(Cells(last_row + 1, Column_to_begin_old + service_line_length1 + number_of_desig), Cells(last_row + 1, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Call create_borders

Range(Cells(last_row + 3, Column_to_begin_old + service_line_length1 + number_of_desig), Cells(last_row + 3, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Call create_borders

Cells(last_row + 3, Column_to_begin_old + service_line_length1 + number_of_desig).Select
ActiveCell.FormulaR1C1 = "=SUM(R6C:R" & last_row & "C)"
Selection.Copy
Range(Cells(last_row + 3, Column_to_begin_old + service_line_length1 + number_of_desig), Cells(last_row + 3, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False
Selection.Font.Bold = True
Call create_borders

Range(Cells(6, Column_to_begin_old + service_line_length1 + number_of_desig + 2), Cells(last_row, Column_to_begin_old + service_line_length1 + number_of_desig + 2)).Select
With Selection.Interior
        .Pattern = xlSolid:        .PatternColorIndex = xlAutomatic:        .ThemeColor = xlThemeColorDark1:        .TintAndShade = -0.149998474074526
End With

subtotal_column(a) = Column_to_begin_old + service_line_length1 + number_of_desig

''Range(Column_to_begin_old & ":" & subtotal_column(a)).Select
Range(Cells(1, Column_to_begin_old), Cells(1, subtotal_column(a) - 1)).EntireColumn.Select
Selection.Columns.Group

Range(Cells(5, subtotal_column(a)), Cells(5, subtotal_column(a) + 3)).Select
Selection.Font.Bold = True
Call create_borders
Call paint_it_purple

Cells(1, Column_to_begin_old).Value = Service_line(a)
Range(Cells(1, Column_to_begin_old), Cells(1, Column_to_begin_old + service_line_length1 + number_of_desig + 3)).Select
Call merge_and_center
Call create_borders
Call paint_it_bluegreen

Workbooks(Filename).Close SaveChanges:=True

Dim aFile As String
aFile = path & "\" & Filename
If Len(Dir$(aFile)) > 0 Then
Kill aFile
End If

NoServiceLine:
Next a

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Grand Totals being calculated"

Cells(last_row + 3, "C").Select
Cells(last_row + 3, "C").Value = "Totals"
Selection.Font.Bold = True
    With Selection.Interior
        .Pattern = xlSolid:        .PatternColorIndex = xlAutomatic:        .Color = 65535
    End With

Range(Cells(2, column_to_begin), Cells(2, column_to_begin + 4)).Select
Call merge_and_center
Call paint_it_green
Call create_borders

ActiveCell.Value = "Grand Total"

Cells(5, column_to_begin).Value = "Budget"
Cells(5, column_to_begin + 1).Value = "Actual"
Cells(5, column_to_begin + 2).Value = "ETC"
Cells(5, column_to_begin + 3).Value = "Proj"
Cells(5, column_to_begin + 4).Value = "Over/(under)"

Range(Cells(5, column_to_begin), Cells(5, column_to_begin + 4)).Select
Selection.Font.Bold = True
Call paint_it_purple
Call create_borders

Range(Cells(5, column_to_begin), Cells(last_row, column_to_begin + 4)).Select
Call create_borders

Cells(6, column_to_begin).Select
ActiveCell.FormulaR1C1 = "=SUMIF(Budget_Range_GrandTotal,'ETC'!RC3,Budget_Hours)"
Cells(6, column_to_begin + 1).Select
ActiveCell.FormulaR1C1 = "=SUMIF(DPS_Grandtotal_Range,'ETC'!RC3,DPS_Grandtotal_Hours)"
Cells(6, column_to_begin + 2).Select

ActiveCell.FormulaR1C1 = "=RC" & subtotal_column(1) + 2 & "+RC" & subtotal_column(2) + 2 & "+RC" & subtotal_column(3) + 2 & "+RC" & subtotal_column(4) + 2 & "+RC" & subtotal_column(5) + 2 & "+RC" & subtotal_column(6) + 2
Cells(6, column_to_begin + 3).Select
ActiveCell.FormulaR1C1 = "=RC[-2]+RC[-1]"
Cells(6, column_to_begin + 4).Select
ActiveCell.FormulaR1C1 = "=RC[-1]-RC[-4]"


Range(Cells(6, column_to_begin), Cells(6, column_to_begin + 4)).Select
Selection.Copy
Range(Cells(6, column_to_begin), Cells(last_row, column_to_begin + 4)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Selection.Copy

''''''''''''

Range(Cells(last_row + 1, column_to_begin), Cells(last_row + 1, column_to_begin + 4)).Select
Call create_borders

Range(Cells(last_row + 3, column_to_begin), Cells(last_row + 3, column_to_begin + 4)).Select
Call create_borders

Cells(last_row + 3, column_to_begin).Select
ActiveCell.FormulaR1C1 = "=SUBTOTAL(9,R6C:R" & last_row & "C)"
Selection.Copy
Range(Cells(last_row + 3, column_to_begin), Cells(last_row + 3, column_to_begin + 4)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False
Selection.Font.Bold = True
Call create_borders

Range(Cells(6, column_to_begin + 2), Cells(last_row + 1, column_to_begin + 2)).Select
With Selection.Interior
        .Pattern = xlSolid:        .PatternColorIndex = xlAutomatic:        .ThemeColor = xlThemeColorDark1:        .TintAndShade = -0.149998474074526
End With

'''''''''''

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Formatting in progress"

Sheets("ETC").Select
Cells.Select
ActiveWindow.Zoom = 80
With Selection.Font
        .Name = "Calibri":        .Size = 11:        .ThemeColor = xlThemeColorLight1:        .ThemeFont = xlThemeFontMinor
End With

Selection.Columns.AutoFit

ActiveWindow.DisplayGridlines = False

Range("A1").Value = "Summary"
Range("A1").Select
Selection.Font.Bold = True


'''''''''''''''''''''''populate dashboards tab

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Dashboards tab recalculated"

Sheets("Dashboards").Select
Cells.Find(What:="total", After:=ActiveCell, LookIn:=xlFormulas, LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=False, SearchFormat:=False).Activate
Dim total_row, details_last_row As Integer
total_row = ActiveCell.Row

details_last_row = Range("C1000").End(xlUp).End(xlUp).Row

Range("H6").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R6C2:R" & last_row & "C2,Dashboards!RC3,ETC!R6C" & column_to_begin & ":R" & last_row & "C" & column_to_begin & ")"
Range("I6").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R6C2:R" & last_row & "C2,Dashboards!RC3,ETC!R6C" & column_to_begin + 1 & ":R" & last_row & "C" & column_to_begin + 1 & ")"
Range("J6").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R6C2:R" & last_row & "C2,Dashboards!RC3,ETC!R6C" & column_to_begin + 2 & ":R" & last_row & "C" & column_to_begin + 2 & ")"
Range("K6").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R6C2:R" & last_row & "C2,Dashboards!RC3,ETC!R6C" & column_to_begin + 3 & ":R" & last_row & "C" & column_to_begin + 3 & ")"
Range("L6").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R6C2:R" & last_row & "C2,Dashboards!RC3,ETC!R6C" & column_to_begin + 4 & ":R" & last_row & "C" & column_to_begin + 4 & ")"
Range("h6:l6").Select
Selection.Copy

For i = 7 To details_last_row
If Trim(Cells(i, 3).Value) <> "" Then
Range(Cells(i, 8), Cells(i, 12)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
End If
Next i

Range("H" & total_row + 1).Select
ActiveCell.FormulaR1C1 = "=IF(R[-1]C=ETC!R" & last_row + 3 & "C" & column_to_begin & ",""Check"",R[-1]C-ETC!R" & last_row + 3 & "C" & column_to_begin & ")"
Range("I" & total_row + 1).Select
ActiveCell.FormulaR1C1 = "=IF(R[-1]C=ETC!R" & last_row + 3 & "C" & column_to_begin + 1 & ",""Check"",R[-1]C-ETC!R" & last_row + 3 & "C" & column_to_begin + 1 & ")"
Range("J" & total_row + 1).Select
ActiveCell.FormulaR1C1 = "=IF(R[-1]C=ETC!R" & last_row + 3 & "C" & column_to_begin + 2 & ",""Check"",R[-1]C-ETC!R" & last_row + 3 & "C" & column_to_begin + 2 & ")"
Range("K" & total_row + 1).Select
ActiveCell.FormulaR1C1 = "=IF(R[-1]C=ETC!R" & last_row + 3 & "C" & column_to_begin + 3 & ",""Check"",R[-1]C-ETC!R" & last_row + 3 & "C" & column_to_begin + 3 & ")"
Range("L" & total_row + 1).Select
ActiveCell.FormulaR1C1 = "=IF(R[-1]C=ETC!R" & last_row + 3 & "C" & column_to_begin + 4 & ",""Check"",R[-1]C-ETC!R" & last_row + 3 & "C" & column_to_begin + 4 & ")"

''''''''''''''Populating Engagement Economics

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Engagement Economics tab recalculated"

Sheets("Engagement Economics").Select
Range("L8").Select
ActiveCell.FormulaR1C1 = "=SUMIF(ETC!R3C5:R3C1000,RC[-2],ETC!R" & last_row + 3 & "C5:R" & last_row + 3 & "C1000)"
Selection.Copy
Range("L8:L20,L22").Select
ActiveSheet.Paste

Sheets("ETC").Select

Range(Cells(5, 3), Cells(5, 3).End(xlDown)).Select
Range(Selection, Selection.End(xlToLeft)).Select
Selection.AutoFilter
Range("A1").Select

ActiveWorkbook.Save

'IncrementalProgress

MsgBox "Thank you for your patience. The file is updated and the calculations are refreshed"

Application.ScreenUpdating = True
Application.DisplayAlerts = True

End Sub

Function SheetExists(SheetName As String)
   Dim s As Excel.Worksheet
   On Error Resume Next
   Set s = ThisWorkbook.Sheets(SheetName)
   On Error GoTo 0
   SheetExists = Not s Is Nothing
 End Function


Sub create_borders()
Selection.Borders(xlDiagonalDown).LineStyle = xlNone
Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous: .Weight = xlMedium
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous:  .Weight = xlMedium
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous:  .Weight = xlMedium
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous:  .Weight = xlMedium
    End With
Selection.Borders(xlInsideVertical).LineStyle = xlNone
Selection.Borders(xlInsideHorizontal).LineStyle = xlNone

End Sub

Sub merge_and_center()
With Selection
        .HorizontalAlignment = xlCenter: .VerticalAlignment = xlBottom: .ReadingOrder = xlContext
End With
Selection.Merge
Selection.Font.Bold = True
End Sub

Sub paint_it_purple()
With Selection.Interior
        .Pattern = xlSolid: .PatternColorIndex = xlAutomatic: .ThemeColor = xlThemeColorAccent4: .TintAndShade = 0.399975585192419
    End With
End Sub

Sub paint_it_blue()
With Selection.Interior
        .Pattern = xlSolid: .PatternColorIndex = xlAutomatic: .ThemeColor = xlThemeColorAccent1: .TintAndShade = 0.399975585192419
    End With
End Sub

Sub paint_it_green()
    With Selection.Interior
        .Pattern = xlSolid: .PatternColorIndex = xlAutomatic: .ThemeColor = xlThemeColorAccent3: .TintAndShade = 0.399975585192419
    End With
End Sub

Sub paint_it_bluegreen()
    With Selection.Interior
        .Pattern = xlSolid: .PatternColorIndex = xlAutomatic: .ThemeColor = xlThemeColorAccent5: .TintAndShade = 0.399975585192419
    End With
End Sub

Sub Button1_Click()
Sheets("Lists").Select
Range("A3").Select
End Sub

Sub Button2_Click()
Sheets("WBS").Select
Range("A3").Select
End Sub


Sub Retain()

Application.ScreenUpdating = False
Application.DisplayAlerts = False
Application.SheetsInNewWorkbook = 3

Dim time_begin As Date
time_begin = DateTime.Now

''IncrementalProgress.Show
''IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Starting execution"

Dim Designations(30) As String
Dim Service_line(30) As String
Dim Emp_name(100) As String
Dim Desig_number(100) As Integer
Dim subtotal_column(10) As Integer
Dim path, Filename As String
Dim a, i, j, k, x As Integer
Dim last_row, last_row1, last_row_desg As Integer
Dim Column_to_begin_old As Integer

Dim Wk As Workbook
path = Application.ActiveWorkbook.path
Set Wk = ActiveWorkbook
   
If Sheets("Exceptions").Range("C2").Value <> "" Then
    Emp_new = Sheets("Exceptions").Range("C2").Value
    Sheets("Lists").Select
     Cells.Find(What:=Emp_new, LookIn:=xlValues).Select       ' Find statement

    ActiveCell.Offset(0, -1).Select
    Range(Selection, Selection.End(xlDown)).Select
    Application.CutCopyMode = False
    Selection.Copy
    Sheets("Exceptions").Select
    Range("E2").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False

    Range("E1").Value = "Service Line"
    Application.CutCopyMode = False
End If
    
If Sheets("Exceptions").Range("C2").Value <> "" And Sheets("Exceptions").Range("E2").Value <> "" Then
Call ETC_Insert_Column
End If

If Sheets("Exceptions").Range("C2").Value <> "" And Sheets("Exceptions").Range("E2").Value = "" Then
MsgBox "Please fill the Service line information for each emoloyee in 'Lists' Tab!"
Exit Sub
Sheets("Main_Interface").Select
End If

''''changes uncomment the service lines

Service_line(1) = "AUDIT"
Service_line(2) = "ERS"
Service_line(3) = "TAX"
Service_line(4) = "LIFE ACTUARIAL"
Service_line(5) = "P&C ACTUARIAL"
Service_line(6) = "USI"

Sheets("Lists").Select
If ActiveSheet.AutoFilterMode = True Then ActiveSheet.AutoFilterMode = False
Range("K4:K1048").Select
Selection.ClearContents

last_row_desg = Range("J4").End(xlDown).Row
For k = 1 To last_row_desg - 3
Cells(k + 3, 11).Value = k
Next k

Sheets("ETC").Select
last_row = Range("B6").End(xlDown).Row


Dim column_to_begin, number_of_desig, l As Integer
Dim Designation As String
column_to_begin = 5

''''''''''''''''''looping begin

For a = 1 To 6

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed:" & Service_line(a)

Filename = Service_line(a) & ".xlsx"
Sheets("Lists").Select
Range("A2:D2").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=1, Criteria1:=(Service_line(a)), Operator:=xlFilterValues

If Range("A1000000").End(xlUp).Row = 2 Then GoTo NoServiceLine

Range(Cells(2, "A"), Cells(2, "C").End(xlDown)).Select
Selection.Copy

Workbooks.Add
ActiveSheet.Paste

ActiveWorkbook.SaveAs path & "\" & Filename
last_row1 = Range("A1").End(xlDown).Row

Range(Cells(1, 3), Cells(last_row1, 3)).Select
Selection.Copy
Sheets("sheet2").Select
ActiveSheet.Paste
ActiveSheet.Range("$A$1:$A$" & last_row1).RemoveDuplicates Columns:=1, Header:=xlYes
number_of_desig = Range("A1").End(xlDown).Row - 1
Range("B1").Value = "order"

Wk.Activate
Sheets("Lists").Select
ActiveSheet.Range("C2").AutoFilter Field:=1
Range("J4:K4").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy
Workbooks(Filename).Activate
Sheets("sheet3").Select
Range("A1").Select
ActiveSheet.Paste

Sheets("Sheet2").Select
Range("b2").Select
ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-1],Sheet3!R1C1:R14C2,2,0)"
Selection.Copy
    Range("A1").End(xlDown).Offset(0, 1).Select
    Range(Selection, Selection.End(xlUp)).Select
    ActiveSheet.Paste
    
    Range("A1:B1").Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Add Key:=Range("B2:B" & number_of_desig + 1) _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet2").Sort
        .SetRange Range("A1:B" & number_of_desig + 1):         .Header = xlYes:         .MatchCase = False:        .Orientation = xlTopToBottom:        .SortMethod = xlPinYin:        .Apply
    End With

For k = 1 To number_of_desig
Designations(k) = Cells(k + 1, 1).Value
Next k

Column_to_begin_old = column_to_begin

For i = 1 To number_of_desig

Workbooks(Filename).Activate
Sheets("sheet1").Select
Range("A1:C1").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=3
ActiveSheet.Range("C2").AutoFilter Field:=3, Criteria1:=(Designations(i)), Operator:=xlFilterValues

Designation = Designations(i)
Range(Cells(1, "B"), Cells(1, "B").End(xlDown)).Select
Selection.Copy
Workbooks.Add
ActiveSheet.Paste
Desig_number(i) = Range("A1").End(xlDown).Row - 1

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation being processed : " & Designation

For k = 1 To Desig_number(i)
Emp_name(k) = Cells(k + 1, 1).Value
Next k
ActiveWorkbook.Close SaveChanges:=False

Wk.Activate
Sheets("ETC").Select

For j = 1 To Desig_number(i)

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation : " & Designation & vbCrLf & "Employee : " & Emp_name(j)

Cells(4, column_to_begin + 4 * (j - 1)).Value = Emp_name(j)
Range(Cells(6, column_to_begin + 4 * (j - 1) + 3), Cells(last_row, column_to_begin + 4 * (j - 1) + 3)).Value = Range(Cells(6, column_to_begin + 4 * (j - 1) + 3), Cells(last_row, column_to_begin + 4 * (j - 1) + 3)).Value

Cells(6, column_to_begin + 4 * (j - 1)).Select
ActiveCell.FormulaR1C1 = "=SUMIF(Budget_Range,'ETC'!RC3&""  ""&'ETC'!R4C,Budget_Hours)"
Cells(6, column_to_begin + 4 * (j - 1) + 1).Select
ActiveCell.FormulaR1C1 = "=SUMIF(DPS_Staff_Area,'ETC'!RC3&""  ""&'ETC'!R4C[-1],DPS_ActualHours)"
Cells(6, column_to_begin + 4 * (j - 1) + 2).Select
ActiveCell.FormulaR1C1 = "=IF(RC[1]-RC[-1]<0,0,RC[1]-RC[-1])"
Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 2)).Formula = Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(6, column_to_begin + 4 * (j - 1) + 2)).Formula
Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 2)).Value = Range(Cells(6, column_to_begin + 4 * (j - 1)), Cells(last_row, column_to_begin + 4 * (j - 1) + 2)).Value

Cells(6, column_to_begin + 4 * (j - 1) + 3).Select
ActiveCell.FormulaR1C1 = "=RC[-2]+RC[-1]"
Range(Cells(6, column_to_begin + 4 * (j - 1) + 3), Cells(last_row, column_to_begin + 4 * (j - 1) + 3)).Formula = Cells(6, column_to_begin + 4 * (j - 1) + 3).Formula

Next j

column_to_begin = Cells(5, column_to_begin).End(xlToRight).Column + 2

Next i

column_to_begin = column_to_begin + 5

Workbooks(Filename).Close SaveChanges:=True

Dim aFile As String
aFile = path & "\" & Filename
If Len(Dir$(aFile)) > 0 Then
Kill aFile
End If

NoServiceLine:
Next a

'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Formatting in progress"

Cells.Select
ActiveWindow.Zoom = 80
With Selection.Font
        .Name = "Calibri": .Size = 11: .ThemeColor = xlThemeColorLight1: .ThemeFont = xlThemeFontMinor
End With

Selection.Columns.AutoFit

ActiveWindow.DisplayGridlines = False

Range("A1").Value = "Summary"
Range("A1").Select
Selection.Font.Bold = True

ActiveWorkbook.Save

'Unload 'IncrementalProgress

MsgBox "Thank you for your patience. The file is updated and the calculations are refreshed"

Application.ScreenUpdating = True
Application.DisplayAlerts = True

End Sub

' Exceptions Tab


Sub Exceptions()
'

Application.ScreenUpdating = False
Application.DisplayAlerts = False

Dim Wk, wk2 As Workbook
Dim path, Filename As String

path = Application.ActiveWorkbook.path
Set Wk = ActiveWorkbook
    Sheets("Exceptions").Select
    Cells.Clear
        
    Sheets("Lists").Select
    Range("B2").Select
    Range(Selection, Selection.End(xlDown)).Select
    Application.CutCopyMode = False
Selection.Copy
Workbooks.Add

Set wk2 = ActiveWorkbook
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Columns("A:A").Select
    Application.CutCopyMode = False
    ActiveSheet.Range("A:A").RemoveDuplicates Columns:=1, Header:=xlYes
    
    Wk.Activate
    Sheets("DPS").Select
    Columns("H:K").Select
    Selection.Copy
    wk2.Activate
    
    Range("D1").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Selection.Columns.AutoFit
    Application.CutCopyMode = False
    
    Columns("D:G").Select
    ActiveWorkbook.Worksheets("Sheet1").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Sheet1").Sort.SortFields.Add Key:=Range( _
        "D:D"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet1").Sort
        .SetRange Range("D:G")
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    ActiveSheet.Range("D:G").RemoveDuplicates Columns:=Array(1, 2, 3, 4), _
        Header:=xlYes
    
    Range("H2").Select
    ActiveCell.FormulaR1C1 = "=ISNA(VLOOKUP(RC[-2],C1,1,0))"
    Range("G2").Select
    Selection.End(xlDown).Select
    ActiveCell.Offset(0, 1).Select
    Range(Selection, Selection.End(xlUp)).Select
    Selection.FillDown
    Range("D1:H1").Select
    Selection.AutoFilter
    ActiveSheet.Range("D:H").AutoFilter Field:=5, Criteria1:="TRUE"
    Range("D1:G1").Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Copy
    
    Wk.Activate
    Sheets("Exceptions").Select
    Range("A1").Select
        Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Selection.Columns.AutoFit
    Application.CutCopyMode = False

If Range("A2") <> "" Then
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Call create_borders
    Range("A1:E1").Select
    Call paint_it_purple
'    Selection.AutoFilter
End If

Sheets("Exceptions").Select
If Range("C2") <> "" Then
Range("C2").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

Sheets("Lists").Select
Range("B2").Select
Selection.End(xlDown).Select
ActiveCell.Offset(1, 0).Select
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
Selection.Columns.AutoFit
Application.CutCopyMode = False

Sheets("Exceptions").Select
Range("E1").Select
ActiveCell.Value = "Service Line"
Cells.Select
ActiveWindow.Zoom = 80
With Selection.Font
        .Name = "Calibri":        .Size = 11:        .ThemeColor = xlThemeColorLight1:        .ThemeFont = xlThemeFontMinor
End With

Selection.Columns.AutoFit

ActiveWindow.DisplayGridlines = False

Range("A2").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

Sheets("Lists").Select
Range("C2").Select
Selection.End(xlDown).Select
ActiveCell.Offset(1, 0).Select
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
Selection.Columns.AutoFit
Application.CutCopyMode = False

Sheets("Exceptions").Select
Range("B2").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy

Sheets("Lists").Select
Range("D2").Select
Selection.End(xlDown).Select
ActiveCell.Offset(1, 0).Select
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
Selection.Columns.AutoFit
Application.CutCopyMode = False

Sheets("Main_Interface").Select
MsgBox "Please update the Service line information in 'Exceptions' tab for all the additional users!"

End If

If Sheets("Exceptions").Range("C2") = "" Then
Cells.Clear
MsgBox "There are no additional employees found in 'DPS' tab"
End If
wk2.Close SaveChanges:=False
End Sub


Sub ETC_Insert_Column()
'
' Macro3 Macro

Application.ScreenUpdating = False
Application.DisplayAlerts = False

Dim time_begin As Date
time_begin = DateTime.Now

'IncrementalProgress.Show
'IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Starting execution"

Dim Designations(30) As String
Dim Service_line(30) As String
Dim Emp_name(100) As String
Dim DPS(20) As String
Dim Emp_new As String
Dim Desig_number(100) As Integer
Dim subtotal_column(10) As Integer
Dim path, Filename As String
Dim a, i, j, k, x As Integer
Dim last_row, last_row1, last_row_desg As Integer
Dim Column_to_begin_old As Integer

Dim Wk As Workbook
path = Application.ActiveWorkbook.path
Set Wk = ActiveWorkbook

''''changes uncomment the service lines

Service_line(1) = "AUDIT"
Service_line(2) = "ERS"
Service_line(3) = "TAX"
Service_line(4) = "LIFE ACTUARIAL"
Service_line(5) = "P&C ACTUARIAL"
Service_line(6) = "USI"
    
    
    Emp_new = Sheets("Exceptions").Range("C2").Value
    Sheets("Lists").Select
     Cells.Find(What:=Emp_new, LookIn:=xlValues).Select       ' Find statement

    ActiveCell.Offset(0, -1).Select
''''' uncomment the code below
    Range(Selection, Selection.End(xlDown)).Select
    Application.CutCopyMode = False
    Selection.Copy
    Sheets("Exceptions").Select
    Range("E2").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False

    Range("E1").Value = "Service Line"
    Application.CutCopyMode = False


Sheets("Lists").Select
Range("K4:K1048").Select
Selection.ClearContents

last_row_desg = Range("J4").End(xlDown).Row
For k = 1 To last_row_desg - 3
Cells(k + 3, 11).Value = k
Next k

Dim column_to_begin, number_of_desig, l As Integer
Dim Designation As String
'column_to_begin = 5

''''''''''''''''''looping begin

For a = 1 To 6

IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed:" & Service_line(a)

Filename = Service_line(a) & ".xlsx"
Sheets("Exceptions").Select
Range("E1").Select
Range(Selection, Selection.End(xlDown)).Select
AutoFilterMode = False
ActiveSheet.Range("C2").AutoFilter Field:=5, Criteria1:=(Service_line(a)), Operator:=xlFilterValues

If Range("E1000000").End(xlUp).Row = 1 Then GoTo NoServiceLine

Range(Cells(1, "E"), Cells(1, "E").End(xlDown)).Select
Selection.Copy

Workbooks.Add
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False

ActiveWorkbook.SaveAs path & "\" & Filename
last_row1 = Range("A1").End(xlDown).Row

Wk.Activate
Sheets("Exceptions").Select
Range(Cells(1, "C"), Cells(1, "C").End(xlDown)).Select
Selection.Copy
Workbooks(Filename).Activate
Range("B1").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False

Wk.Activate
Sheets("Exceptions").Select
Range(Cells(1, "A"), Cells(1, "A").End(xlDown)).Select
Selection.Copy
Workbooks(Filename).Activate
Range("C1").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False

Range(Cells(1, 3), Cells(last_row1, 3)).Select
Selection.Copy
Sheets("sheet2").Select
ActiveSheet.Paste
ActiveSheet.Range("$A$1:$A$" & last_row1).RemoveDuplicates Columns:=1, Header:=xlYes
number_of_desig = Range("A1").End(xlDown).Row - 1
Range("B1").Value = "order"

Wk.Activate
Sheets("Lists").Select
ActiveSheet.Range("C2").AutoFilter Field:=1
Range("J4:K4").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy
Workbooks(Filename).Activate
Sheets("sheet3").Select
Range("A1").Select
ActiveSheet.Paste

Sheets("Sheet2").Select
Range("b2").Select
ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-1],Sheet3!R1C1:R14C2,2,0)"
Selection.Copy
    Range("A1").End(xlDown).Offset(0, 1).Select
    Range(Selection, Selection.End(xlUp)).Select
    ActiveSheet.Paste
    
    Range("A1:B1").Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Sheet2").Sort.SortFields.Add Key:=Range("B2:B" & number_of_desig + 1) _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet2").Sort
        .SetRange Range("A1:B" & number_of_desig + 1):         .Header = xlYes:         .MatchCase = False:        .Orientation = xlTopToBottom:        .SortMethod = xlPinYin:        .Apply
    End With

For k = 1 To number_of_desig
Designations(k) = Cells(k + 1, 1).Value
Next k

Column_to_begin_old = column_to_begin

For i = 1 To number_of_desig

Workbooks(Filename).Activate
Sheets("sheet1").Select
Range("A1:C1").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=3
ActiveSheet.Range("C2").AutoFilter Field:=3, Criteria1:=(Designations(i)), Operator:=xlFilterValues

Designation = Designations(i)
Range(Cells(1, "B"), Cells(1, "B").End(xlDown)).Select
Selection.Copy
Workbooks.Add
ActiveSheet.Paste
Desig_number(i) = Range("A1").End(xlDown).Row - 1

IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation being processed : " & Designation

For k = 1 To Desig_number(i)
Emp_name(k) = Cells(k + 1, 1).Value
Next k
ActiveWorkbook.Close SaveChanges:=False

Wk.Activate
Sheets("ETC").Select
last_row = Range("B6").End(xlDown).Row
For j = 1 To Desig_number(i)

IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation : " & Designation & vbCrLf & "Employee : " & Emp_name(j)
Rows(1).Select
Cells.Find(What:=Service_line(a), LookIn:=xlValues).Select       ' Find statement
Rowtobeg = ActiveCell.Row
Coltobeg = ActiveCell.Column

ActiveCell.Offset(1, 1).Select
Coltoend = ActiveCell.Column - 1

Range(Cells(Rowtobeg + 1, Coltobeg), Cells(Rowtobeg + 1, Coltoend)).Select

On Error Resume Next

Cells.Find(What:=Designations(i), LookIn:=xlValues).Select       ' Find statement

If Err.Number = 0 Then
Range(Cells(Rowtobeg + 1, Coltobeg), Cells(Rowtobeg + 1, Coltoend)).Select
Cells.Find(What:=Designations(i), LookIn:=xlValues).Select       ' Find statement
Coltobeg_des = ActiveCell.Column
ActiveCell.Offset(1, 1).Select
Coltoend_des = ActiveCell.Column - 1
Else

'''''''''

Sheets("Lists").Select
Range("A2:D2").Select
Range(Selection, Selection.End(xlDown)).Select
ActiveSheet.Range("C2").AutoFilter Field:=1, Criteria1:=(Service_line(a)), Operator:=xlFilterValues

If Range("A1000000").End(xlUp).Row = 2 Then GoTo NoServiceLine1

Range(Cells(2, "C"), Cells(2, "C").End(xlDown)).Select
Selection.Copy

Workbooks.Add
ActiveSheet.Paste
Set wk_oder = ActiveWorkbook

last_row2 = Range("A1").End(xlDown).Row

ActiveSheet.Range("$A$1:$A$" & last_row2).RemoveDuplicates Columns:=1, Header:=xlYes
Range("B1").Value = "order"

Wk.Activate
Sheets("Lists").Select
ActiveSheet.Range("C2").AutoFilter Field:=1
Range("J4:K4").Select
Range(Selection, Selection.End(xlDown)).Select
Selection.Copy
wk_oder.Activate
Range("G1").Select
ActiveSheet.Paste

    Range("B2").Select
    ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-1],R2C7:R15C8,2,0)"
Selection.Copy
    Range("A1").End(xlDown).Offset(0, 1).Select
    Range(Selection, Selection.End(xlUp)).Select
    ActiveSheet.Paste
    
    Range("A1:B1").Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("Sheet1").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Sheet1").Sort.SortFields.Add Key:=Range("B2:B" & number_of_desig + 1) _
        , SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet1").Sort
        .SetRange Range("A1:B" & last_row2): .Header = xlYes: .MatchCase = False: .Orientation = xlTopToBottom: .SortMethod = xlPinYin: .Apply
    End With

NoServiceLine1:
Range("B1:B &last_row2").Value = Range("B1:B &last_row2").Value
Range("G:H").Clear
Range("A:A").Select
Cells.Find(What:=Designations(i), LookIn:=xlValues).Select       ' Find statement

'For m = 1 To last_row2 - ActiveCell.Row
DPS(1) = ActiveCell.Offset(1, 0).Value
'Next m

ActiveWorkbook.Close SaveChanges:=False

Sheets("ETC").Select
last_row = Range("B6").End(xlDown).Row

IncrementalProgress.Display "Time of start : " & time_begin & vbCrLf & "Time elapsed : " & Format(DateTime.Now - time_begin, "h:m:s"), "Service line being processed : " & Service_line(a) & vbCrLf & "Designation : " & Designation & vbCrLf & "Employee : " & Emp_name(j)
Rows(1).Select
Cells.Find(What:=Service_line(a), LookIn:=xlValues).Select       ' Find statement
Rowtobeg = ActiveCell.Row
Coltobeg = ActiveCell.Column

ActiveCell.Offset(1, 1).Select
Coltoend = ActiveCell.Column - 1

''''''''''
If DPS(1) <> "" Then
Range(Cells(Rowtobeg + 1, Coltobeg), Cells(Rowtobeg + 1, Coltoend)).Select
Cells.Find(What:=DPS(1), LookIn:=xlValues).Select       ' Find statement
ActiveCell.Offset(0, -1).Select
Coltobeg_des = ActiveCell.Column
Coltoend_des = ActiveCell.Column
'ActiveCell.Offset(0, -1).Select
    ActiveCell.EntireColumn.Insert
End If

If DPS(1) = "" Then
Range(Cells(Rowtobeg + 3, Coltobeg), Cells(Rowtobeg + 3, Coltoend)).Select
Cells.Find(What:="SUB TOTAL", LookIn:=xlValues).Select       ' Find statement
ActiveCell.Offset(-2, -2).Select
Coltobeg_des = ActiveCell.Column
Coltoend_des = ActiveCell.Column
ActiveCell.Offset(0, -1).Select
    ActiveCell.EntireColumn.Insert
End If
End If

For Col = 1 To 4
    ActiveCell.EntireColumn.Insert
Next Col
column_to_begin = Coltoend_des + 1
Range(Cells(2, Coltoend_des), Cells(5, Coltoend_des)).Clear
Cells(3, column_to_begin + 2).Select

Cells(3, column_to_begin + 2).Value = Designation
Cells(5, column_to_begin).Value = "Budget"
Cells(5, column_to_begin + 1).Value = "Actual"
Cells(5, column_to_begin + 2).Value = "ETC"
Cells(5, column_to_begin + 3).Value = "Proj"

Cells(4, column_to_begin).Value = Emp_name(j)

Range(Cells(4, column_to_begin), Cells(4, column_to_begin + 3)).Select
Call merge_and_center
Call paint_it_blue
Call create_borders

Range(Cells(5, column_to_begin), Cells(5, column_to_begin + 3)).Select
Selection.Font.Bold = True
Call paint_it_purple
Call create_borders

Range(Cells(5, column_to_begin), Cells(last_row, column_to_begin + 3)).Select
Call create_borders

Cells(6, column_to_begin).Select
ActiveCell.FormulaR1C1 = "=SUMIF(Budget_Range,'ETC'!RC3&""  ""&'ETC'!R4C,Budget_Hours)"
Cells(6, column_to_begin + 1).Select
ActiveCell.FormulaR1C1 = "=SUMIF(DPS_Staff_Area,'ETC'!RC3&""  ""&'ETC'!R4C[-1],DPS_ActualHours)"
Cells(6, column_to_begin + 2).Select
ActiveCell.FormulaR1C1 = "=IF(RC[-2]-RC[-1]<0,0,RC[-2]-RC[-1])"
Cells(6, column_to_begin + 3).Select
ActiveCell.FormulaR1C1 = "=RC[-2]+RC[-1]"

'Range(Cells(6, column_to_begin), Cells(6, column_to_begin + 3)).Select
'Selection.Copy
Range(Cells(6, column_to_begin), Cells(last_row, column_to_begin + 3)).Formula = Range(Cells(6, column_to_begin), Cells(6, column_to_begin + 3)).Formula
'Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
'Application.CutCopyMode = False
Range(Cells(6, column_to_begin), Cells(last_row, column_to_begin + 2)).Value = Range(Cells(6, column_to_begin), Cells(last_row, column_to_begin + 2)).Value
'Selection.Copy
'Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
'Application.CutCopyMode = False


Range(Cells(last_row + 1, column_to_begin), Cells(last_row + 1, column_to_begin + 3)).Select
Call create_borders

Range(Cells(last_row + 3, column_to_begin), Cells(last_row + 3, column_to_begin + 3)).Select
Call create_borders

Cells(last_row + 3, column_to_begin).Select
ActiveCell.FormulaR1C1 = "=SUBTOTAL(9,R6C:R" & last_row & "C)"
Selection.Copy
Range(Cells(last_row + 3, column_to_begin), Cells(last_row + 3, column_to_begin + 3)).Select
Selection.PasteSpecial Paste:=xlPasteFormulas, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False
Selection.Font.Bold = True
Call create_borders

Range(Cells(6, column_to_begin + 2), Cells(last_row + 1, column_to_begin + 2)).Select
With Selection.Interior
        .Pattern = xlSolid: .PatternColorIndex = xlAutomatic: .ThemeColor = xlThemeColorDark1:  .TintAndShade = -0.149998474074526

End With


Next j

'Range(Cells(2, column_to_begin), Cells(2, column_to_begin + 3)).Select
If Cells(2, Coltoend_des).MergeCells = True Then
Range(Cells(2, Coltoend_des), Cells(2, Coltoend_des + 4)).Select
Else
Range(Cells(2, Coltoend_des + 1), Cells(2, Coltoend_des + 4)).Select
End If

Call merge_and_center
Selection.Font.Bold = True
Call paint_it_green
Call create_borders

ActiveCell.Value = Designation

'column_to_begin = Cells(5, column_to_begin).End(xlToRight).Column + 2
Workbooks(Filename).Close SaveChanges:=False

Dim aFile As String
aFile = path & "\" & Filename
If Len(Dir$(aFile)) > 0 Then
Kill aFile
End If

NoServiceLine:
Next i

Next

Sheets("ETC").Select
Cells.Select
ActiveWindow.Zoom = 80
With Selection.Font
        .Name = "Calibri": .Size = 11:  .ThemeColor = xlThemeColorLight1: .ThemeFont = xlThemeFontMinor
End With

Selection.Columns.AutoFit
Range("A1").Select
ActiveWindow.DisplayGridlines = False

End Sub

Sub goback()
Sheets("Main_Interface").Select
End Sub

Sub gobackui()
Sheets("ETC").Select
    ActiveSheet.ShowAllData
Sheets("User Interface").Select
End Sub



